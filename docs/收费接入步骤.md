# 日语假名标注工具 - 收费接入步骤

当前项目已具备：创建订单、支付回调、升级页、Premium 用户无限次。要真正收款，按下面步骤接入一家支付平台即可。

---

## 一、选一家支付平台并注册

| 类型 | 平台示例 | 说明 |
|------|----------|------|
| 国内聚合（支付宝/微信） | 虎皮椒、PayJS、易支付、 stripe 中国 | 注册后获得 APPID、密钥，在后台配置异步通知 URL |
| 国际 | Stripe | 适合海外用户，文档完善 |

任选一家，在对方后台创建应用并拿到 **应用 ID（APPID）**、**密钥（Key/Secret）**。

---

## 二、在 Vercel 配置环境变量

在项目 **Settings → Environment Variables** 中已配或补全：

| 变量 | 说明 | 示例 |
|------|------|------|
| **PAYMENT_API_URL** | 支付平台「下单」接口地址 | 按平台文档，如 `https://api.xxx.com/v1/order` |
| **PAYMENT_APPID** | 应用 ID | 平台后台复制 |
| **PAYMENT_KEY** | 密钥（用于签名/验签） | 平台后台复制，勿泄露 |
| **PAYMENT_NOTIFY_URL** | 异步回调地址（支付成功后平台 POST） | `https://你的域名.vercel.app/api/payment/callback` |
| **PAYMENT_RETURN_URL** | 用户支付完成跳转 | `https://你的域名.vercel.app/dashboard?paid=1` |

保存后 **Redeploy** 一次。

---

## 三、在支付平台后台配置回调

1. 登录所选支付平台后台。
2. 找到「异步通知地址」「Notify URL」「回调地址」等配置项。
3. 填写：**PAYMENT_NOTIFY_URL** 的完整 URL（即 `https://你的域名/api/payment/callback`）。
4. 保存。

这样用户支付成功后，平台会 POST 到你的 `/api/payment/callback`，你的服务会更新订单并给用户开通 Premium。

---

## 四、按平台文档对接下单与验签

当前 `lib/payment.ts` 里是**示例逻辑**（通用参数 + 未实现签名）。不同平台接口字段、签名算法不同，需要按所选平台文档做两件事：

### 4.1 创建订单（下单）接口

- 查阅平台「下单」「创建订单」文档。
- 在 `lib/payment.ts` 的 `createPaymentOrder` 中：
  - 使用平台要求的 **请求方式**（GET/POST）、**参数名**（如 `out_trade_no`、`total_amount`、`notify_url` 等）。
  - 按文档计算 **签名** 并带入请求（很多平台用 MD5 或 HMAC，参数排序后拼接再加密）。
- 解析平台返回，取出 **支付链接** 或 **二维码链接**，赋给 `payUrl` 或 `qrCode` 返回给前端。

### 4.2 回调验签

- 查阅平台「异步通知」「回调」文档。
- 在 `lib/payment.ts` 的 `handlePaymentNotify` 中：
  - 按文档用 **PAYMENT_KEY** 和回调 body 计算签名，与平台传来的 `sign` 比对，**验签通过再更新订单**。
  - 确认订单状态字段（如 `trade_status === 'TRADE_SUCCESS'`）后再把 `Order.status` 置为 `paid`、`User.isPremium` 置为 `true`。
  - 返回平台要求的字符串（常见为 `success`）和 200 状态码。

对接完成后，用户点击「升级无限次」→ 选择支付宝/微信 → 跳转支付 → 支付成功 → 回调更新 → 用户变为 Premium，即可无限次使用标注。

---

## 五、金额与定价

- 当前代码里 **PREMIUM_AMOUNT_CENTS = 990**（9.9 元）。若平台按「元」传参，在 `createPaymentOrder` 里传 `total_fee: 9.9` 或平台要求的字段即可。
- 修改 `lib/payment.ts` 顶部 `PREMIUM_AMOUNT_CENTS` 或传参即可改价。

---

## 六、自测清单

- [ ] Vercel 环境变量已填且已 Redeploy
- [ ] 支付平台后台已配置异步通知 URL 为 `/api/payment/callback`
- [ ] 下单接口按平台文档实现（参数 + 签名），能拿到支付链接
- [ ] 回调验签按平台文档实现，验签通过才更新订单和 isPremium
- [ ] 用小额或沙箱实际走一遍：下单 → 支付 → 收到回调 → 用户变为 Premium

完成以上步骤后即可正式收费。若你选定具体平台（如虎皮椒、PayJS、Stripe），可按该平台文档在 `lib/payment.ts` 中实现对应下单与回调逻辑。
