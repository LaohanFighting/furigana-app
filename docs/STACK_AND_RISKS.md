# 日语通（furigana-app）技术栈与长期运营风险

## 一、当前用到的所有东西

### 1. 应用技术栈

| 类别 | 技术 | 用途 |
|------|------|------|
| 框架 | Next.js 14 | 全栈 React、API Routes、SSR |
| 语言 | TypeScript | 类型安全 |
| 样式 | Tailwind CSS | UI |
| 假名注音 | kuroshiro + kuromoji | 日语汉字→假名标注（纯前端/服务端均可） |
| 数据库 ORM | Prisma | 连接 PostgreSQL、迁移 |
| 数据库 | PostgreSQL | 用户、会话、订单、验证码等（Neon / Vercel Postgres 等） |
| 会话 | jose (JWT) + 自管 Session | Cookie 登录态 |
| ID | nanoid | 订单号等 |
| 邮件 | nodemailer | 发信；可选 Resend API 或 SMTP |
| 短信 | @alicloud/pop-core | 阿里云短信验证码（可选） |

### 2. 外部服务与依赖

| 服务 | 用途 | 是否必选 |
|------|------|----------|
| **OpenAI API** | 中文翻译、单词解释（Chat）、日语朗读（TTS） | 可选（不配则仅假名可用） |
| **Cloudflare AI Gateway** | 大陆服务器访问 OpenAI 的代理；可选开启认证（CLOUDFLARE_AIG_TOKEN） | 大陆部署时推荐 |
| **PostgreSQL** | 用户、Session、订单、Verification | 必选 |
| **Resend 或 SMTP** | 邮箱验证码 | 可选 |
| **阿里云短信** | 手机验证码 | 可选 |
| **虎皮椒（讯虎支付）** | 支付与回调 | 可选（收费时用） |
| **腾讯云轻量（Lighthouse）** | 大陆部署：Docker 宿主机 | 当前大陆实例 |
| **Docker** | 应用容器化运行 | 轻量部署必选 |

### 3. 部署与运行方式

- **大陆访问**：腾讯云轻量 + Docker（端口 3001，与 xunhu-proxy 等共存）
- **数据库**：通常为 Neon 或 Vercel Postgres（与 Vercel 部署共用同一库也可）
- **环境变量**：见 `.env.example`；大陆部署需 `OPENAI_API_BASE` + 可选 `CLOUDFLARE_AIG_TOKEN`

---

## 二、长期运营风险与应对

### 1. 成本与用量

| 风险 | 说明 | 建议 |
|------|------|------|
| **OpenAI 费用** | 按 token/请求计费，翻译、解释、TTS 都会产生费用 | 设用量/预算告警；必要时对免费用户限频或仅开放部分功能 |
| **Cloudflare AI Gateway** | 有免费额度，超量可能收费或限流 | 在 Dashboard 关注用量与限额 |
| **数据库** | Neon/Vercel Postgres 免费档有行数/存储限制 | 定期看用量；用户/订单表做归档或清理策略 |
| **服务器** | 轻量按量/包月，续费与升配成本 | 固定日历提醒续费；考虑预留预算 |

### 2. 第三方策略与可用性

| 风险 | 说明 | 建议 |
|------|------|------|
| **OpenAI 政策/地区** | API 条款、地区限制可能变更，大陆直连已不可用 | 已用 Cloudflare 代理；若代理失效可换其他代理或备用模型 |
| **Cloudflare 网关策略** | 认证方式、限额、产品调整 | 文档与 token 集中保管；关注 Cloudflare 公告 |
| **支付渠道** | 虎皮椒等支付平台规则、费率、停服 | 保留回调与对账逻辑；必要时可接第二家支付 |
| **邮件/短信** | Resend、SMTP、阿里云短信的合规与限流 | 验证码限频；重要操作留邮件+可选的短信双通道 |

### 3. 安全与合规

| 风险 | 说明 | 建议 |
|------|------|------|
| **密钥泄露** | OPENAI_API_KEY、CLOUDFLARE_AIG_TOKEN、SESSION_SECRET、支付密钥等 | 全部放 .env，不入库；生产用强随机 SESSION_SECRET；定期轮换 |
| **会话与权限** | 越权、会话固定 | 已用 JWT+HttpOnly Cookie；管理员审批逻辑需严格校验身份 |
| **支付回调** | 伪造成功通知 | 必须验签（lib/payment.ts 已做）；PAYMENT_NOTIFY_URL 用 HTTPS |
| **用户数据** | 邮箱、手机、订单 | 隐私政策与条款已存在；长期考虑数据最小化与定期清理 |

### 4. 运维与可用性

| 风险 | 说明 | 建议 |
|------|------|------|
| **单点故障** | 单台轻量、单数据库、单区域 | 重要服务可考虑数据库只读副本、多区域部署（成本允许时） |
| **代码与配置不同步** | 服务器未拉代码或未重建镜像导致 401 等 | 文档已强调「改代码或 .env 后必须 rebuild + 重启」；可做简单发布检查清单 |
| **依赖与漏洞** | npm 依赖过期或爆 CVE | 定期 `npm audit`、升级 Next/React/Prisma 等主依赖 |
| **备份** | 数据库未备份 | 使用 Neon/Vercel Postgres 的自动备份；必要时定期导出关键表 |

### 5. 产品与合规

| 风险 | 说明 | 建议 |
|------|------|------|
| **内容与使用** | 用户生成内容、滥用 AI 能力 | 保留条款与使用限制；必要时做内容过滤或举报机制 |
| **付费与退款** | 争议、退款政策 | 退款页与支付文档已有；与支付方约定清楚退款流程 |

---

## 三、简要清单（长期维护可对照）

- [ ] **成本**：OpenAI / Cloudflare / 数据库 / 服务器 用量与预算
- [ ] **密钥**：所有 API Key、Token、SESSION_SECRET 仅环境变量、定期轮换
- [ ] **部署**：代码或 .env 变更后必 `docker build` 再重启
- [ ] **依赖**：定期 `npm audit` 与升级
- [ ] **备份**：确认数据库有自动或定期备份
- [ ] **监控**：至少关注应用是否存活、5xx 与支付回调失败

以上为当前网站用到的全部组件及长期运营时的主要风险与应对方向；具体策略可按实际用户量与预算再细化。
